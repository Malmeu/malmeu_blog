---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { ADMIN_CONFIG } from '../../lib/admin';

// Check if already logged in
const cookies = Astro.cookies;
const isLoggedIn = cookies.get('admin_session')?.value === 'authenticated';

if (isLoggedIn) {
  return Astro.redirect('/admin/comments');
}
---

<BaseLayout 
  title="Connexion Admin"
  description="Acc√®s √† l'administration des commentaires"
  noIndex
>
  <div class="min-h-screen flex items-center justify-center px-4">
    <div class="max-w-md w-full">
      <div class="bg-[var(--color-bg-secondary)] rounded-xl p-8 shadow-xl">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold text-[var(--color-text)] mb-2">
            üîê Admin
          </h1>
          <p class="text-[var(--color-text-muted)]">
            Acc√®s √† la mod√©ration des commentaires
          </p>
        </div>

        <form id="login-form" class="space-y-6">
          <div>
            <label for="password" class="block text-sm font-medium text-[var(--color-text)] mb-2">
              Mot de passe admin
            </label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              required
              class="w-full px-4 py-3 bg-[var(--color-bg)] border border-[var(--color-bg)] rounded-lg text-[var(--color-text)] placeholder-[var(--color-text-muted)] focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)] focus:border-transparent"
              placeholder="Entrez votre mot de passe"
            />
          </div>

          <div id="error-message" class="hidden bg-red-500/10 border border-red-500/20 rounded-lg p-4 text-red-400 text-center">
            ‚ùå Mot de passe incorrect
          </div>

          <button 
            type="submit"
            id="login-button"
            class="w-full px-6 py-3 bg-[var(--color-accent)] text-[var(--color-bg)] rounded-lg font-medium hover:opacity-90 transition-opacity focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)] focus:ring-offset-2 focus:ring-offset-[var(--color-bg-secondary)]"
          >
            Se connecter
          </button>
        </form>

        <div class="mt-6 text-center">
          <p class="text-xs text-[var(--color-text-muted)]">
            Session s√©curis√©e ‚Ä¢ D√©connexion automatique apr√®s 24h
          </p>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script type="module" define:vars={{ adminPassword: ADMIN_CONFIG.PASSWORD }}>
  // Password validation (change ADMIN_CONFIG.PASSWORD in src/lib/admin.ts for production)
  const ADMIN_PASSWORD = adminPassword;
  
  const loginForm = document.getElementById('login-form');
  const errorMessage = document.getElementById('error-message');
  const loginButton = document.getElementById('login-button');
  
  if (loginForm) {
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const password = document.getElementById('password').value;
      
      // Show loading state
      const originalText = loginButton.textContent;
      loginButton.textContent = 'Connexion...';
      loginButton.disabled = true;
      
      try {
        // Validate password
        if (password === ADMIN_PASSWORD) {
          // Set session cookie (24 hours)
          document.cookie = 'admin_session=authenticated; path=/; max-age=86400; secure; samesite=strict';
          
          // Redirect to admin page
          window.location.href = '/admin/comments';
        } else {
          // Show error
          errorMessage.classList.remove('hidden');
          document.getElementById('password').value = '';
          
          // Hide error after 3 seconds
          setTimeout(() => {
            errorMessage.classList.add('hidden');
          }, 3000);
        }
      } catch (error) {
        console.error('Login error:', error);
        errorMessage.classList.remove('hidden');
      } finally {
        // Reset button state
        loginButton.textContent = originalText;
        loginButton.disabled = false;
      }
    });
  }
</script>
