---
interface Props {
  slug: string;
}

const { slug } = Astro.props;
---

<div class="flex items-center gap-4 py-4" id="reactions-container" data-slug={slug}>
  <span class="text-sm text-[var(--color-text-muted)]">Cet article vous a plu ?</span>
  
  <div class="flex items-center gap-2">
    <button 
      class="reaction-btn flex items-center gap-1 px-3 py-1.5 rounded-full bg-[var(--color-bg-secondary)] hover:bg-[var(--color-accent)]/20 transition-all"
      data-reaction="like"
    >
      <span class="text-lg">üëç</span>
      <span class="reaction-count text-sm font-medium text-[var(--color-text-muted)]">0</span>
    </button>
    
    <button 
      class="reaction-btn flex items-center gap-1 px-3 py-1.5 rounded-full bg-[var(--color-bg-secondary)] hover:bg-[var(--color-accent)]/20 transition-all"
      data-reaction="love"
    >
      <span class="text-lg">‚ù§Ô∏è</span>
      <span class="reaction-count text-sm font-medium text-[var(--color-text-muted)]">0</span>
    </button>
    
    <button 
      class="reaction-btn flex items-center gap-1 px-3 py-1.5 rounded-full bg-[var(--color-bg-secondary)] hover:bg-[var(--color-accent)]/20 transition-all"
      data-reaction="fire"
    >
      <span class="text-lg">üî•</span>
      <span class="reaction-count text-sm font-medium text-[var(--color-text-muted)]">0</span>
    </button>
    
    <button 
      class="reaction-btn flex items-center gap-1 px-3 py-1.5 rounded-full bg-[var(--color-bg-secondary)] hover:bg-[var(--color-accent)]/20 transition-all"
      data-reaction="think"
    >
      <span class="text-lg">ü§î</span>
      <span class="reaction-count text-sm font-medium text-[var(--color-text-muted)]">0</span>
    </button>
  </div>
</div>

<script is:inline>
  (function() {
    const container = document.getElementById('reactions-container');
    const slug = container?.getAttribute('data-slug');
    
    // G√©n√©rer un fingerprint simple pour identifier l'utilisateur
    function getFingerprint() {
      let fp = localStorage.getItem('user_fingerprint');
      if (!fp) {
        fp = 'fp_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        localStorage.setItem('user_fingerprint', fp);
      }
      return fp;
    }
    
    const fingerprint = getFingerprint();
    let userReaction = localStorage.getItem(`user_reaction_${slug}`);
    
    // Charger les compteurs depuis l'API
    async function loadReactions() {
      try {
        const res = await fetch(`/api/reactions?slug=${slug}`);
        const counts = await res.json();
        
        document.querySelectorAll('.reaction-btn').forEach(btn => {
          const reaction = btn.getAttribute('data-reaction');
          const countEl = btn.querySelector('.reaction-count');
          if (reaction && countEl && counts[reaction] !== undefined) {
            countEl.textContent = counts[reaction];
          }
          
          // Highlight user's previous reaction
          if (reaction === userReaction) {
            btn.classList.add('ring-2', 'ring-[var(--color-accent)]');
          }
        });
      } catch (e) {
        console.log('Could not load reactions');
      }
    }
    
    // Envoyer une r√©action √† l'API
    async function sendReaction(reaction) {
      try {
        await fetch('/api/reactions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, reaction, fingerprint })
        });
      } catch (e) {
        console.log('Could not save reaction');
      }
    }
    
    // Initialiser
    loadReactions();
    
    // Event listeners
    document.querySelectorAll('.reaction-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const currentReaction = btn.getAttribute('data-reaction');
        if (!currentReaction) return;
        
        // Remove previous highlight
        document.querySelectorAll('.reaction-btn').forEach(b => {
          b.classList.remove('ring-2', 'ring-[var(--color-accent)]');
        });
        
        const countEl = btn.querySelector('.reaction-count');
        const currentCount = parseInt(countEl?.textContent || '0');
        
        if (userReaction === currentReaction) {
          // Toggle off
          if (countEl) countEl.textContent = Math.max(0, currentCount - 1);
          localStorage.removeItem(`user_reaction_${slug}`);
          userReaction = null;
        } else {
          // Decrement old reaction
          if (userReaction) {
            const oldBtn = document.querySelector(`[data-reaction="${userReaction}"]`);
            const oldCount = oldBtn?.querySelector('.reaction-count');
            if (oldCount) oldCount.textContent = Math.max(0, parseInt(oldCount.textContent || '1') - 1);
          }
          
          // Add new reaction
          if (countEl) countEl.textContent = currentCount + 1;
          localStorage.setItem(`user_reaction_${slug}`, currentReaction);
          userReaction = currentReaction;
          btn.classList.add('ring-2', 'ring-[var(--color-accent)]');
        }
        
        // Sync with server
        await sendReaction(currentReaction);
      });
    });
  })();
</script>
