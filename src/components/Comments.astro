---
import { supabase, type Comment } from '../lib/supabase';

interface Props {
  slug: string;
  title: string;
}

const { slug, title } = Astro.props;

// Fetch approved comments for this article
let comments: Comment[] = [];
if (supabase) {
  const { data: approvedComments, error } = await supabase
    .from('comments')
    .select('*')
    .eq('article_slug', slug)
    .eq('status', 'approved')
    .order('created_at', { ascending: true });
  
  comments = approvedComments || [];
}
---

<!-- Comments Section -->
<section class="mt-16 pt-8 border-t border-[var(--color-bg-secondary)]">
  <div class="max-w-4xl mx-auto">
    <h3 class="text-2xl font-bold text-[var(--color-text)] mb-6">
      üí¨ Commentaires
    </h3>
    
    <!-- Comment Form -->
    <div class="bg-[var(--color-bg-secondary)] rounded-xl p-6 mb-6">
      {supabase ? (
        <form id="comment-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="name" class="block text-sm font-medium text-[var(--color-text)] mb-2">
              Nom *
            </label>
            <input 
              type="text" 
              id="name" 
              name="name" 
              required
              class="w-full px-4 py-2 bg-[var(--color-bg)] border border-[var(--color-bg)] rounded-lg text-[var(--color-text)] placeholder-[var(--color-text-muted)] focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)] focus:border-transparent"
              placeholder="Votre nom"
            />
          </div>
          <div>
            <label for="email" class="block text-sm font-medium text-[var(--color-text)] mb-2">
              Email *
            </label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              required
              class="w-full px-4 py-2 bg-[var(--color-bg)] border border-[var(--color-bg)] rounded-lg text-[var(--color-text)] placeholder-[var(--color-text-muted)] focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)] focus:border-transparent"
              placeholder="votre@email.com"
            />
          </div>
        </div>
        
        <div>
          <label for="comment" class="block text-sm font-medium text-[var(--color-text)] mb-2">
            Commentaire *
          </label>
          <textarea 
            id="comment" 
            name="comment" 
            rows="4" 
            required
            class="w-full px-4 py-2 bg-[var(--color-bg)] border border-[var(--color-bg)] rounded-lg text-[var(--color-text)] placeholder-[var(--color-text-muted)] focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)] focus:border-transparent resize-vertical"
            placeholder="Partagez vos pens√©es..."
          ></textarea>
        </div>
        
        <div class="flex items-center justify-between">
          <p class="text-sm text-[var(--color-text-muted)]">
            Votre email ne sera pas publi√©. Les champs obligatoires sont marqu√©s *
          </p>
          <button 
            type="submit"
            class="px-6 py-2 bg-[var(--color-accent)] text-[var(--color-bg)] rounded-lg font-medium hover:opacity-90 transition-opacity focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)] focus:ring-offset-2 focus:ring-offset-[var(--color-bg-secondary)]"
          >
            Publier le commentaire
          </button>
        </div>
      </form>
      ) : (
        <div class="text-center py-8">
          <p class="text-[var(--color-text-muted)] mb-4">
            üí¨ Les commentaires sont temporairement d√©sactiv√©s.
          </p>
          <p class="text-sm text-[var(--color-text-muted)]">
            Configuration de la base de donn√©es requise.
          </p>
        </div>
      )}
    </div>
    
    <!-- Comments List -->
    <div id="comments-list" class="space-y-6">
      {comments.length > 0 ? (
        comments.map((comment) => (
          <div class="bg-[var(--color-bg-secondary)] rounded-xl p-6">
            <div class="flex items-start gap-4">
              <div class="w-10 h-10 bg-gradient-to-br from-[var(--color-accent)] to-[var(--color-accent-orange)] rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-white font-bold">{comment.name.substring(0, 2).toUpperCase()}</span>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <h4 class="font-semibold text-[var(--color-text)]">{comment.name}</h4>
                  <span class="text-sm text-[var(--color-text-muted)]">‚Ä¢ {new Date(comment.created_at).toLocaleDateString('fr-DZ')}</span>
                </div>
                <p class="text-[var(--color-text)] leading-relaxed whitespace-pre-wrap">{comment.content}</p>
                <button class="mt-3 text-sm text-[var(--color-accent)] hover:text-[var(--color-accent-orange)] transition-colors">
                  R√©pondre
                </button>
              </div>
            </div>
          </div>
        ))
      ) : (
        <div class="text-center py-8 text-[var(--color-text-muted)]">
          <p>Soyez le premier √† commenter cet article !</p>
        </div>
      )}
      
      <!-- Placeholder for new comments (pending) -->
      <div id="new-comments" class="space-y-6"></div>
    </div>
    
    <!-- Success Message -->
    <div id="success-message" class="hidden bg-green-500/10 border border-green-500/20 rounded-lg p-4 text-green-400 text-center">
      ‚úÖ Merci pour votre commentaire ! Il sera visible apr√®s mod√©ration.
    </div>
  </div>
</section>

<script type="module" define:vars={{ slug: slug, title: title }}>
  // Article data passed from Astro
  const articleSlug = slug;
  const articleTitle = title;
  
  // Check if Supabase is configured
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  
  console.log('Supabase URL:', supabaseUrl ? 'configured' : 'missing');
  console.log('Supabase Key:', supabaseAnonKey ? 'configured' : 'missing');
  console.log('Article slug:', articleSlug);
  console.log('Article title:', articleTitle);
  
  if (!supabaseUrl || !supabaseAnonKey) {
    console.log('Supabase not configured - comments disabled');
  } else {
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';
    const supabase = createClient(supabaseUrl, supabaseAnonKey);
  
    // Handle comment form submission
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
      commentForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Form submitted');
        
        const target = e.target;
        if (!target) return;
        
        // Get form data
        const formData = new FormData(target);
        const nameValue = formData.get('name');
        const emailValue = formData.get('email');
        const commentValue = formData.get('comment');
        
        // Type guards
        if (!nameValue || !emailValue || !commentValue || 
            typeof nameValue !== 'string' || 
            typeof emailValue !== 'string' || 
            typeof commentValue !== 'string') {
          return;
        }
        
        console.log('Form data:', { nameValue, emailValue, commentValue, articleSlug, articleTitle });
        
        // Show loading state
        const submitButton = target.querySelector('button[type="submit"]');
        const originalText = submitButton?.textContent;
        if (submitButton) {
          submitButton.textContent = 'Envoi en cours...';
          submitButton.disabled = true;
        }
        
        try {
          console.log('Inserting comment into Supabase...');
          // Insert comment into Supabase
          const { data, error } = await supabase
            .from('comments')
            .insert({
              name: nameValue,
              email: emailValue,
              content: commentValue,
              article_slug: articleSlug,
              article_title: articleTitle,
              status: 'pending'
            })
            .select();
          
          console.log('Supabase response:', { data, error });
          
          if (error) {
            console.error('Supabase error:', error);
            throw error;
          }
          
          console.log('Comment inserted successfully!');
          
          // Show success message
          const successMessage = document.getElementById('success-message');
          if (successMessage) {
            successMessage.classList.remove('hidden');
          }
          
          // Reset form
          target.reset();
          
          // Hide success message after 5 seconds
          setTimeout(() => {
            if (successMessage) {
              successMessage.classList.add('hidden');
            }
          }, 5000);
          
        } catch (error) {
          console.error('Error submitting comment:', error);
          alert('Une erreur est survenue. Veuillez r√©essayer plus tard.');
        } finally {
          // Reset button state
          if (submitButton) {
            submitButton.textContent = originalText;
            submitButton.disabled = false;
          }
        }
      });
    }
  }
}
</script>
